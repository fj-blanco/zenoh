## Testing Zenoh with `rustls_post_quantum` CryptoProvider and ROS 2

## Building Zenoh

First, update Rust to the latest version:

```bash
rustup update
```

Then, build Zenoh with all targets in release mode:

```bash
cargo build --release --all-targets
```

## Testing Zenoh's Publisher and Subscriber with TLS and X25519Kyber768Draft00 Post-Quantum Key Exchange

### Generate the certificates

#### Using OpenSSL directly

Use the `generate_certs.sh` script inside the `certs/openssl`folder.

#### Using SROS2

You need to build ROS 2 and source it in your terminal (you can refer for example to this [documentation](https://github.com/fj-blanco/sros2/blob/pq/build_ros2_jazzy.md))

```bash
source <your_ros2_installation>/install/setup.bash
```

If you have installed ROS2 (Jazzy Jalisco) from binary packages probably you have to run `source /opt/ros/jazzy/setup.bash`

```bash
ros2 security create_keystore ./certs/keystore
ros2 security create_enclave ./certs/keystore /zenoh_router --replace
ros2 security create_enclave ./certs/keystore /zenoh_client --replace
```

### Running an example

Start the Zenoh router:

```bash
./target/release/zenohd -c ./pq_config/sros2/router.json5
```

In a separate terminal, start a subscriber:

```bash
./target/release/examples/z_sub -c ./pq_config/sros2/client.json5
```

In another terminal, start a publisher:

```bash
./target/release/examples/z_pub -c ./pq_config/sros2/client.json5
```

*Note*: change `/pq_config/sros2` by `/pq_config/openssl` for using the OpenSSL generated certificates.

### Analyzing the Traffic

Use Wireshark to filter the traffic by `tcp.port==7447` and ensure that you see TLSv1.3 traffic.

In the `Client Hello`you should see the following supported groups:

* Unkwnown

This occurs because we have disabled all traditional key exchanges and left only `X25519Kyber768Draft00` (0x6399), which is not recognized by Wireshark.

If you build Zenoh with the default provider instead (not available in this repositoryâ€”simply clone Zenoh from the official repository), you will see:

* x25519
* secp256r1
* secp384r1

**Note**: These are traditional (non post-quantum) elliptic curves.

## Testing ROS 2 with `rmw_zenoh` and Post-Quantum TLS

### Building Custom Zenoh, zenoh-c, and rmw_zenoh

We need to build custom versions of `zenoh-c` and `rmw_zenoh` that uses our Zenoh fork with post-quantum TLS support. [zenoh-c](https://github.com/eclipse-zenoh/zenoh-c) is a C API for Zenoh, providing language bindings for the Zenoh protocol. It directly depends on the core [Zenoh](https://github.com/eclipse-zenoh/zenoh) implementation. [rmw_zenoh](https://github.com/ros2/rmw_zenoh) is the ROS 2 middleware implementation for Zenoh, which depends on `zenoh-c` to interface with the Zenoh protocol. By building custom versions of these components, we ensure that the entire stack from ROS 2 down to the core Zenoh implementation supports post-quantum TLS.

#### Build Custom zenoh-c

Run

```bash
./scripts/build_custom_zenoh_c.sh
```

This script does the following:

* Clones the zenoh-c repository.
* Modifies the `Cargo.toml` file to use our Zenoh fork with PQC integragion (from https://github.com/fj-blanco/zenoh.git, branch `pq`).
* Builds zenoh-c with the custom Zenoh implementation.

#### Build Custom rmw_zenoh

After building zenoh-c, run:

```bash
./scripts/build_custom_rmw_zenoh.sh
```

 After building, you'll need to source `~/ws_rmw_zenoh/install/setup.bash` in every terminal where you plan to run ROS 2 nodes with `rmw_zenoh`. You can find further details in the official `rmw_zenoh` [GitHub repository](https://github.com/ros2/rmw_zenoh).

#### Setup Environment

We now have to source both the ROS 2  Jazzy and `rmw_zenoh`

```bash
source /opt/ros/jazzy/setup.bash
source ~/ws_rmw_zenoh/install/setup.bash
export RMW_IMPLEMENTATION=rmw_zenoh_cpp
```

We've created a script to set up the environment. Run this in each terminal you open:

```bash
source ./scripts/setup_custom_zenoh_env.sh
```

### Running a test

We will use configuration files `zenoh/pq_config/rmw_zenoh/router.json5` and `zenoh/pq_config/rmw_zenoh/client.json5`, which are based on the [DEFAULT_RMW_ZENOH_ROUTER_CONFIG.json5](https://github.com/ros2/rmw_zenoh/blob/rolling/rmw_zenoh_cpp/config/DEFAULT_RMW_ZENOH_ROUTER_CONFIG.json5) and [DEFAULT_RMW_ZENOH_SESSION_CONFIG.json5](https://github.com/ros2/rmw_zenoh/blob/rolling/rmw_zenoh_cpp/config/DEFAULT_RMW_ZENOH_SESSION_CONFIG.json5) respectively. These files are modified to include TLS configurations to use the certificates generated by SROS2, as shown in the earlier examples.

#### Start the Zenoh Router

In a terminal, start the Zenoh router:

```bash
source ./scripts/setup_custom_zenoh_env.sh
export ZENOH_ROUTER_CONFIG_URI=./pq_config/rmw_zenoh/router.json5
ros2 run rmw_zenoh_cpp rmw_zenohd
```

#### Run the ROS 2 Talker

In a new terminal, set up the ROS 2 environment and configure it to use Zenoh:

```bash
source ./scripts/setup_custom_zenoh_env.sh
export ZENOH_SESSION_CONFIG_URI=./pq_config/rmw_zenoh/client.json5
ros2 run demo_nodes_cpp talker
```

#### Run the ROS 2 Listener

In another terminal, set up the environment again and run a ROS 2 listener:

```bash
source ./scripts/setup_custom_zenoh_env.sh
export ZENOH_SESSION_CONFIG_URI=./pq_config/rmw_zenoh/client.json5
ros2 run demo_nodes_cpp listener
```

To confirm that the ROS 2 nodes are communicating using post-quantum TLS, you can analyze the network traffic as explained in the previous Zenoh publisher/subscriber test. You should observe analogous behavior, with the presence of the "Unknown" group (representing `X25519Kyber768Draft00`) in the Client Hello messages, indicating the use of post-quantum key exchange.